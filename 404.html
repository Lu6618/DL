<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/js/bootstrap.min.js"></script>
    <title>简短分享 - 长网址缩短，文本分享，Html单页分享</title>
</head>
<body class="d-flex h-100 text-center text-white bg-dark">
    <div class="position-fixed top-0 end-0 p-3 black-toast" style="z-index: 5;">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body">已复制到剪贴板！</div>
        </div>
    </div>

    <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
        <header class="mb-auto">
            <nav class="navbar navbar-expand-md navbar-dark">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">简短分享</a>
                </div>
            </nav>
        </header>

        <main class="px-3">
            <p id="result" class="lead" onclick="copyToClipboard()"></p>
            <br>
            <div id="input-container">
                <div id="link_div" class="input-group mb-3">
                    <select class="form-control" id="select">
                        <option value="link">Link</option>
                        <option value="text">Text</option>
                        <option value="html">HTML</option>
                    </select>
                    <select class="form-control" id="expiration">
                        <option value="-1">无限制</option>
                        <option value="burn_after_reading">阅后即焚</option>
                        <option value="1">1分钟</option>
                        <option value="10">10分钟</option>
                        <option value="60">1小时</option>
                        <option value="1440">1天</option>
                        <option value="10080">7天</option>
                        <option value="43200">1个月</option>
                    </select>
                    <input type="text" id="name" placeholder="自定义后缀" class="input-group-text">
                </div>
            </div>
            <div id="text_div">
                <textarea id="link" placeholder="输入链接/文本/HTML源代码" class="form-control" rows="10"></textarea><br>
            </div>
            <p class="lead">
                <a href="#" onclick="getlink()" class="btn btn-lg btn-secondary fw-bold border-white bg-white">生成</a>
            </p>
        </main>
    </div>

    <footer class="footer">
        <div class="container">
            <a href="https://www.cloudflare.com/" class="text-muted">基于Cloudflare-WorkerKV的</a>
            <a href="https://github.com/Aiayw/CloudflareWorkerKV-UrlShort" class="text-muted">开源项目</a>
        </div>
    </footer>

    <script>
        async function postData(url = '', data = {}) {
            const response = await fetch(url, {
                method: 'POST',
                mode: 'cors',
                cache: 'no-cache',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json'
                },
                redirect: 'follow',
                referrerPolicy: 'no-referrer',
                body: JSON.stringify(data)
            });
            return response.json();
        }

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }
      
        function copyToClipboard() {
            const textToCopy = document.getElementById('result').innerText;
            if (textToCopy) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const toast = new bootstrap.Toast(document.getElementById('toast'));
                    toast.show();
                }).catch(err => {
                    console.error('无法复制文本: ', err);
                });
            } else {
                alert('没有文本可复制');
            }
        }
        
        function getlink() {
            let link = document.getElementById('link').value.trim()
            const name = document.getElementById('name').value
            const type = document.getElementById('select').value
            if (link === '') {
                document.getElementById('result').innerHTML = "请输入链接/文本/HTML源代码"
                return;
            }
            if (link.indexOf('http') == -1 && type == "link") {
                link = 'http://' + link
            }
            if (type == "link" && !isValidUrl(link)) {
                document.getElementById('result').innerHTML = "请输入有效的URL格式"
                return;
            }
            document.getElementById('result').innerHTML = "生成中.."
            const expirationElement = document.getElementById('expiration');
            const selectedIndex = expirationElement.selectedIndex;
            const expiration = expirationElement.options[selectedIndex].value;
            const burnAfterReading = expiration === 'burn_after_reading';
            postData("${API_PATH}", {
                "${URL_KEY}": link,
                "${URL_NAME}": name,
                "type": type,
                "expiration": burnAfterReading ? -1 : expiration,
                "burn_after_reading": burnAfterReading
            }).then(resp => {
                if (resp.error) {
                    document.getElementById('result').innerHTML = resp.error;
                    document.getElementById('name').value = ''
                } else if (resp.value) {
                    document.getElementById('result').innerHTML = resp.value;
                } else {
                    var url = document.location.protocol + '//' + document.location.host + '/' + resp['${URL_NAME}']
                    document.getElementById('result').innerHTML = url
                    document.getElementById('link').value = ''
                    document.getElementById('name').value = ''
                    document.getElementById('select').selectedIndex = 0
                }
            });
        }
    </script>

</body>
</html>